<VirtualHost *:80>
    ServerName laravel.test
    ServerAlias *
    DocumentRoot /var/www/html/public

    <Directory /var/www/html/public>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Pass X-Forwarded headers to PHP (for ngrok/reverse proxy support)
    SetEnvIf X-Forwarded-Proto "https" HTTPS=on

    # Nota: Vite dev server Ã¨ accessibile direttamente sulla porta 5173 (mappata da Docker)
    # Non serve proxy Apache per Vite, il browser carica direttamente da localhost:5173
    
    # Configurazione per Reverb (WebSocket e HTTP)
    # Usa ProxyPass per tutto (HTTP e WebSocket)
    ProxyPreserveHost On
    
    # WebSocket Upgrade per Reverb
    # Quando arriva una richiesta WebSocket a /app/, la inoltriamo a Reverb mantenendo il path /app/
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteCond %{REQUEST_URI} ^/app/ [NC]
    RewriteRule ^/app/(.*) ws://localhost:6001/app/$1 [P,L]
    
    # HTTP normale per /app/ (per richieste non-WebSocket)
    ProxyPass        /app/ http://localhost:6001/app/
    ProxyPassReverse /app/ http://localhost:6001/app/

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
