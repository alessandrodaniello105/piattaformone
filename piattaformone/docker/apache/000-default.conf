<VirtualHost *:80>
    ServerName laravel.test
    DocumentRoot /var/www/html/public

    <Directory /var/www/html/public>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Pass X-Forwarded headers to PHP (for ngrok/reverse proxy support)
    SetEnvIf X-Forwarded-Proto "https" HTTPS=on

    # Proxy per Vite dev server (quando public/hot esiste)
    RewriteEngine On
    
    # Proxy per Vite WebSocket HMR
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/(@vite|resources)/.* ws://localhost:5173%{REQUEST_URI} [P,L]

    # Proxy per richieste HTTP normali a Vite
    ProxyPassMatch ^/(@vite|resources)/ http://localhost:5173/
    ProxyPassReverse / http://localhost:5173/
    
    # Configurazione per Reverb (WebSocket e HTTP)
    # Usa ProxyPass per tutto (HTTP e WebSocket)
    ProxyPreserveHost On
    
    # WebSocket Upgrade per Reverb
    # Quando arriva una richiesta WebSocket a /app/, la inoltriamo a Reverb mantenendo il path /app/
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteCond %{REQUEST_URI} ^/app/ [NC]
    RewriteRule ^/app/(.*) ws://localhost:6001/app/$1 [P,L]
    
    # HTTP normale per /app/ (per richieste non-WebSocket)
    ProxyPass        /app/ http://localhost:6001/app/
    ProxyPassReverse /app/ http://localhost:6001/app/

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
